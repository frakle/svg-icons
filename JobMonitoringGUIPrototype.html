<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mass Sealing – Monitoring GUI (Material 3)</title>
  <!-- Material 3 Web Components -->
  <script type="module">
    import 'https://esm.run/@material/web/all.js';
  </script>
  <!-- Material Symbols (Rounded) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    :root {
      /* Simple light/dark seeds; can be replaced by dynamic scheme */
      --md-sys-color-primary: #6750a4;
      --md-sys-color-surface: #fffbfe;
      --md-sys-color-on-surface: #1c1b1f;
      --md-sys-color-error: #b3261e;
      --container-max: 1260px;
    }
    :root[data-theme="dark"] {
      --md-sys-color-surface: #111014;
      --md-sys-color-on-surface: #e6e1e5;
      --md-sys-color-primary: #d0bcff;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
    }
    .appbar {
      position: sticky; top: 0; z-index: 10;
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px; border-bottom: 1px solid #0001;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--md-sys-color-surface), transparent 10%);
    }
    .appbar h1 { font-size: 18px; font-weight: 700; margin: 0; }
    .container { max-width: var(--container-max); margin: 24px auto; padding: 0 16px; }
    .grid { display: grid; gap: 16px; }
    .grid.kpi { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid.twocol { grid-template-columns: 1.2fr 1fr; }
    @media (max-width: 980px){ .grid.kpi, .grid.twocol { grid-template-columns: 1fr; } }

    md-elevated-card { width: 100%; }
    .kpi { display:flex; flex-direction:column; gap:8px; padding:16px; }
    .kpi .label { opacity: .7; font-size: 14px; }
    .kpi .value { font-size: 28px; font-weight: 700; letter-spacing: .2px; }

    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; font-size: 12px; letter-spacing: .08em; text-transform: uppercase; opacity: .7; padding: 12px 8px; border-bottom: 1px solid #0002; }
    tbody td { padding: 12px 8px; border-bottom: 1px solid #0001; vertical-align: middle; }
    tbody tr:hover { background: #0001; cursor: pointer; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .chip.running { background:#e3f2fd; color:#0b57d0; }
    .chip.completed { background:#e8f5e9; color:#1e8e3e; }
    .chip.failed { background:#fdecea; color:#b00020; }

    .row-controls { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .grow { flex: 1 1 auto; }

    /* Simple progress bar */
    .progress { position: relative; height: 8px; background: #0002; border-radius: 999px; overflow: hidden; }
    .progress > i { position:absolute; left:0; top:0; bottom:0; width: 0; background: var(--md-sys-color-primary); border-radius: 999px; transition: width .4s ease; }

    .muted { opacity:.7; }
    canvas { width: 100%; height: 220px; }
  </style>
</head>
<body>
  <header class="appbar">
    <md-icon class="material-symbols-rounded">insights</md-icon>
    <h1>Mass Sealing – Monitoring</h1>
    <span class="grow"></span>
    <md-switch id="themeSwitch" icons>
      <div slot="selectedIcon" class="material-symbols-rounded">dark_mode</div>
      <div slot="unselectedIcon" class="material-symbols-rounded">light_mode</div>
    </md-switch>
  </header>

  <main class="container">
    <!-- Filters / Controls -->
    <div class="row-controls" style="margin-bottom:12px">
      <md-outlined-text-field id="tenantFilter" label="Tenant (Pension Fund)" placeholder="PF-12345" style="min-width:260px"></md-outlined-text-field>
      <md-outlined-select id="statusFilter" label="Status" style="min-width:180px">
        <md-select-option selected value="all"><div slot="headline">All</div></md-select-option>
        <md-select-option value="running"><div slot="headline">Running</div></md-select-option>
        <md-select-option value="queued"><div slot="headline">Queued</div></md-select-option>
        <md-select-option value="completed"><div slot="headline">Completed</div></md-select-option>
        <md-select-option value="failed"><div slot="headline">Failed</div></md-select-option>
        <md-select-option value="partial"><div slot="headline">Partial</div></md-select-option>
      </md-outlined-select>
      <md-filled-button id="refreshBtn"><md-icon class="material-symbols-rounded" slot="icon">refresh</md-icon>Refresh</md-filled-button>
      <md-tonal-button id="autoBtn" selected><md-icon class="material-symbols-rounded" slot="icon">autorenew</md-icon>Auto‑Refresh</md-tonal-button>
    </div>

    <!-- KPI Cards -->
    <section class="grid kpi" id="kpiSection">
      <md-elevated-card><div class="kpi"><div class="label">Active Jobs</div><div class="value" id="kpiActive">–</div></div></md-elevated-card>
      <md-elevated-card><div class="kpi"><div class="label">Documents Today</div><div class="value" id="kpiDocs">–</div></div></md-elevated-card>
      <md-elevated-card><div class="kpi"><div class="label">Error Rate</div><div class="value" id="kpiErr">–</div></div></md-elevated-card>
    </section>

    <!-- Charts & Snapshot -->
    <section class="grid twocol" style="margin-top:16px">
      <md-elevated-card>
        <div class="kpi" style="gap:12px">
          <div class="label">Throughput (Docs/min)</div>
          <canvas id="throughputChart" height="220"></canvas>
        </div>
      </md-elevated-card>
      <md-elevated-card>
        <div class="kpi" style="gap:6px">
          <div class="label">Snapshot</div>
          <div class="muted" id="snapshotText">–</div>
        </div>
      </md-elevated-card>
    </section>

    <!-- Jobs Table -->
    <section style="margin-top:16px">
      <md-elevated-card>
        <div class="kpi" style="gap:0">
          <div class="row-controls" style="margin-bottom:8px">
            <div class="label">Jobs</div>
            <span class="grow"></span>
            <md-outlined-text-field id="searchJob" label="Search Job ID" style="min-width:220px"></md-outlined-text-field>
          </div>
          <div style="overflow:auto">
          <table id="jobsTable" aria-label="Jobs Table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Tenant</th>
                <th>Mode</th>
                <th>Progress</th>
                <th>Status</th>
                <th>Start</th>
                <th>End</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          </div>
        </div>
      </md-elevated-card>
    </section>
  </main>

  <!-- Job Detail Dialog -->
  <md-dialog id="jobDialog">
    <div slot="headline">Job Details</div>
    <form id="jobForm" method="dialog" slot="content">
      <div id="jobDetail" class="muted">Lade…</div>
      <div style="margin-top:12px">
        <div style="font-weight:600; margin-bottom:6px">Batches</div>
        <table id="batchTable">
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>State</th>
              <th>Signed/Failed</th>
              <th>Latency</th>
              <th>Payload</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:12px">
        <div style="font-weight:600; margin-bottom:6px">Failures</div>
        <table id="failTable">
          <thead>
            <tr>
              <th>docId</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </form>
    <div slot="actions">
      <md-text-button form="jobForm">Schließen</md-text-button>
    </div>
  </md-dialog>

  <script>
    // --- CONFIG ---
    const USE_MOCK = true;              // set to false and configure BASE_URL to call real APIs
    const BASE_URL = '';                // e.g. 'https://api.example.com'
    const AUTO_INTERVAL_MS = 8000;      // auto refresh interval

    // --- STATE ---
    let autoTimer = null;
    let jobs = [];
    let batchesByJob = new Map();

    // --- HELPERS ---
    const $ = sel => document.querySelector(sel);
    const fmt = new Intl.NumberFormat('de-CH');
    const fmtPct = v => (v*100).toFixed(1)+'%';
    const nowISO = () => new Date().toISOString();

    function chip(status){
      const s = (status||'').toLowerCase();
      const cls = s.includes('run')? 'running' : s.includes('fail')? 'failed' : s.includes('queue')? 'running' : s.includes('partial')? 'running' : 'completed';
      return `<span class="chip ${cls}"><span class="material-symbols-rounded" style="font-size:16px">$${{running:'autorenew',failed:'error',completed:'check_circle'}[cls]}</span>${status}</span>`;
    }

    // --- MOCK API ---
    function mockData(){
      const seed = Math.floor(Date.now()/5000)%1000;
      const rng = (min,max)=> Math.floor(min + (seed % (max-min+1)));
      const base = [
        { id:'Run-42', tenant:'PF-12345', mode:'Swisscom', done: 84000 + (seed%1200), total: 100000, status:'Running', start:'2025-09-01T08:01:00Z', end:null },
        { id:'Run-41', tenant:'PF-12345', mode:'SES',      done: 20000, total: 20000, status:'Completed', start:'2025-09-01T06:00:00Z', end:'2025-09-01T06:25:00Z' },
        { id:'Run-40', tenant:'PF-98765', mode:'Swisscom', done:  500,  total: 1000,   status:'Failed',    start:'2025-09-01T05:10:00Z', end:'2025-09-01T05:40:00Z' }
      ];
      // mock batches
      batchesByJob.set('Run-42', Array.from({length: 6}, (_,i)=>({
        id: `Run-42-${i+1}`, state: i<4? 'completed': i===4? 'submitted':'planned', signed: i<4? 18000: 0, failed: i===2? 2:0, latencyMs: 700+ i*60, payloadBytes: 6_500_000 + i*110_000
      })));
      batchesByJob.set('Run-40', [
        { id:'Run-40-1', state:'failed', signed:500, failed:500, latencyMs: 1200, payloadBytes: 7_900_000 }
      ]);
      return base;
    }

    async function apiListJobs(){
      if (USE_MOCK) return mockData();
      const r = await fetch(`${BASE_URL}/jobs`); return r.json();
    }

    async function apiGetBatches(jobId){
      if (USE_MOCK) return batchesByJob.get(jobId)||[];
      const r = await fetch(`${BASE_URL}/batches?jobId=${encodeURIComponent(jobId)}`); return r.json();
    }

    // --- RENDER ---
    function renderKPIs(){
      const active = jobs.filter(j=> ['Running','Queued','Partial'].includes(j.status)).length;
      const docsToday = jobs.reduce((a,j)=> a + (j.status==='Completed'? j.total : j.done), 0);
      const errRate = jobs.reduce((a,j)=> a + (j.total - j.done), 0) / Math.max(1, jobs.reduce((a,j)=> a+j.total,0));
      $('#kpiActive').textContent = fmt.format(active);
      $('#kpiDocs').textContent = fmt.format(docsToday);
      $('#kpiErr').textContent = fmtPct(errRate);
      $('#snapshotText').textContent = `Stand ${new Date().toLocaleString('de-CH')} · Jobs: ${jobs.length}`;
    }

    function drawChart(){
      const cvs = $('#throughputChart');
      const ctx = cvs.getContext('2d');
      const w = cvs.width = cvs.clientWidth * devicePixelRatio;
      const h = cvs.height = cvs.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      // synthetic data from jobs
      const points = Array.from({length: 12}, (_,i)=> ({t: i, v: Math.max(200, 2000 + Math.sin((Date.now()/1000 + i)/2)*1200)}));
      const maxV = Math.max(...points.map(p=>p.v));
      const pad = 36 * devicePixelRatio;
      const barW = (w - pad*2) / points.length * 0.7;
      ctx.fillStyle = '#0006';
      ctx.font = `${12*devicePixelRatio}px system-ui`;
      ctx.textAlign = 'center';
      points.forEach((p,i)=>{
        const x = pad + i * ((w-pad*2)/points.length) + barW/2;
        const bh = (h - pad*2) * (p.v/maxV);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-primary')||'#6750a4';
        ctx.fillRect(x - barW/2, h - pad - bh, barW, bh);
      });
      // axes
      ctx.strokeStyle = '#0003';
      ctx.beginPath(); ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();
    }

    function renderJobs(){
      const tbody = $('#jobsTable tbody');
      tbody.innerHTML = '';
      const tenantQ = ($('#tenantFilter').value||'').trim().toLowerCase();
      const statusQ = ($('#statusFilter').value||'all').toLowerCase();
      const idQ = ($('#searchJob').value||'').trim().toLowerCase();

      jobs
        .filter(j=> tenantQ? j.tenant.toLowerCase().includes(tenantQ) : true)
        .filter(j=> idQ? j.id.toLowerCase().includes(idQ) : true)
        .filter(j=> statusQ==='all' ? true : j.status.toLowerCase().includes(statusQ))
        .forEach(j=>{
          const tr = document.createElement('tr');
          const pct = Math.min(100, Math.round(j.done / j.total * 100));
          tr.innerHTML = `
            <td>${j.id}</td>
            <td>${j.tenant}</td>
            <td>${j.mode}</td>
            <td>
              <div class="progress" title="${pct}%">
                <i style="width:${pct}%"></i>
              </div>
              <div class="muted" style="margin-top:4px">${fmt.format(j.done)} / ${fmt.format(j.total)}</div>
            </td>
            <td>${chip(j.status)}</td>
            <td>${j.start? new Date(j.start).toLocaleString('de-CH') : '—'}</td>
            <td>${j.end? new Date(j.end).toLocaleString('de-CH') : '—'}</td>
          `;
          tr.addEventListener('click', ()=> openJobDetail(j));
          tbody.appendChild(tr);
        });
    }

    async function openJobDetail(job){
      const dialog = $('#jobDialog');
      $('#jobDetail').innerHTML = `<div><b>${job.id}</b> · Tenant <b>${job.tenant}</b> · Mode <b>${job.mode}</b> · Status ${chip(job.status)}</div>`;
      // batches
      const batches = await apiGetBatches(job.id);
      const bt = $('#batchTable tbody'); bt.innerHTML = '';
      batches.forEach(b=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.id}</td>
          <td>${b.state}</td>
          <td>${fmt.format(b.signed)} / ${fmt.format(b.failed)}</td>
          <td>${b.latencyMs} ms</td>
          <td>${fmt.format(b.payloadBytes)} B</td>
        `;
        bt.appendChild(tr);
      });
      // failures (collect from batches with failed > 0 in mock)
      const ft = $('#failTable tbody'); ft.innerHTML = '';
      if (job.id==='Run-40'){
        [{docId:'V-000777', reason:'STS_TIMEOUT'}, {docId:'V-000778', reason:'PDF_INVALID'}].forEach(f=>{
          const tr = document.createElement('tr'); tr.innerHTML = `<td>${f.docId}</td><td>${f.reason}</td>`; ft.appendChild(tr);
        });
      }
      dialog.show();
    }

    // --- EVENT WIRING ---
    $('#refreshBtn').addEventListener('click', refresh);
    $('#tenantFilter').addEventListener('input', renderJobs);
    $('#statusFilter').addEventListener('change', renderJobs);
    $('#searchJob').addEventListener('input', renderJobs);

    $('#autoBtn').addEventListener('click', (e)=>{
      const btn = e.currentTarget;
      const on = btn.hasAttribute('selected');
      if (on){
        btn.removeAttribute('selected');
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = null;
      } else {
        btn.setAttribute('selected','');
        autoTimer = setInterval(refresh, AUTO_INTERVAL_MS);
      }
    });

    $('#themeSwitch').addEventListener('change', (e)=>{
      document.documentElement.dataset.theme = e.target.selected ? 'dark' : 'light';
      drawChart();
    });

    // --- MAIN REFRESH ---
    async function refresh(){
      jobs = await apiListJobs();
      renderKPIs();
      renderJobs();
      drawChart();
    }

    // initial
    refresh();
    autoTimer = setInterval(refresh, AUTO_INTERVAL_MS);
    window.addEventListener('resize', drawChart);
  </script>
</body>
</html>
